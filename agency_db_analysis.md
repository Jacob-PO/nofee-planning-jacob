# 에이전시 운영 DB 현황 리포트 (2025-11-05)

> 원본 DB: `db_nofee` (host: 43.203.125.223) / 추출 시각: 2025-11-05  ✅ 모든 쿼리는 `utf8mb4_general_ci` 로 강제 접속하여 수행했습니다.

## 1. 견적 · 고객 데이터 흐름 (tb_apply_phone)

| Step 코드 | 상태명 | 전체 | 매장 배정 | 미배정 | 개통 정보 수집됨 (`open_info_yn='Y'`)
| --- | --- | ---:| ---:| ---:| ---:|
| 0201001 | 신청 | 7 | 4 | 3 | 0 |
| 0201003 | 대응완료(개통안함) | 101 | 101 | 0 | 82 |
| 0201004 | 개통 진행중 | 68 | 68 | 0 | 22 |
| 0201005 | 개통완료 | 47 | 47 | 0 | 40 |
| 0201006 | 반려 | 2,860 | 2,521 | 339 | 217 |
| 0201007 | 취소 | 1,018 | 60 | 958 | 110 |

**핵심 관찰**
- `0201002 (진행중)` 코드는 실제 데이터에서 한 건도 사용되지 않아 “견적 확인하기” 단계가 사실상 운영되지 않는 상태입니다.
- `반려/취소`가 전체의 **~87% (3,878/4,101)** 를 차지하며, 특히 반려된 2,521건이 매장에 이미 배정되어 있었습니다. 매장 입장에서는 DB를 구매하고도 대부분 취소/반려로 끝나는 구조입니다.
- 최근 14일간 신규/진행 기록이 **2025-11-03 개통진행 1건뿐**이며, 마지막 개통완료는 **2025-10-14**에 발생했습니다. 현재 파이프라인이 멈춰 있는 것이 데이터로 확인됩니다.
- `open_info_yn='Y'` 인데도 매장 미배정인 건이 89건으로, 고객이 직접 개통 정보를 입력해도 매장 UI에서 관리가 어렵다는 뜻입니다.
- 평균 처리시간(신청→현재 상태)도 `반려` 15.1일, `개통완료` 18.6일로 병목이 길게 발생합니다 (`TIMESTAMPDIFF` 기반 계산).

## 2. 매장 캐시 & DB 구매 (tb_store_purchase, tb_store)

- `tb_store_purchase` 총 **3,180건** 기록 / 캐시 차감 합계 **4,110,000원**.
- `free_yn='Y'` 인 무료 처리 비중이 **2,826건(89%)** 로 매우 높습니다. 유료 결제 로직은 있으나 실제 과금은 거의 이루어지지 않음.
- 매장 구매가 반려/취소로 끝나는 사례: `LEFT JOIN` 기준 **2,722건**이 현재 `step_code=0201006(반려)` 상태로 남아있음. 환불 요청(`refund_request_yn='Y'`)은 단 한 건도 없어, 프로세스상 환불 플로우가 사용되지 않는 것이 확인됩니다.
- 매장 캐시(`tb_store.cash`) 총액은 12,235,000원(평균 235k)인데, 주요 매장(예: store_no 46, 51 등)은 캐시 잔액이 0원으로 고정돼 있습니다. 월 구독 모델 전환 이후 캐시/차감 로직이 사실상 의미 없는 상태입니다.

## 3. 개통 정보 입력 (tb_apply_phone_user)

- 총 **475명**이 개통 정보를 입력했고, 그중 **303명(64%)**만 신분증 파일까지 업로드했습니다.
- 그러나 `tb_apply_phone` 기준으로 개통 진행/완료 상태(`0201004/0201005`) 중 실제로 `open_info_yn='Y'` 인 건은 각각 22건/40건에 불과합니다. 고객이 정보를 입력해도 상태가 붙지 않거나 매장 관리 화면으로 전달되지 않는 사례가 큽니다.

## 4. 매장 운영 현황 (tb_store)

| 스토어 step_code | 의미 | 개수 |
| --- | --- | ---:|
| 0202001 | 등록중 | 36 |
| 0202002 | 검수중 | 6 |
| 0202003 | 검수완료(운영중) | 10 |

- 실질적으로 운영 준비가 끝난 매장은 10곳뿐이며, DB 배정이 일어나는 38개 매장이 모두 운영 승인 상태는 아닙니다. 매장 승인/정산 구조부터 정비해야 고객 데이터 메뉴를 단순화할 수 있습니다.
- 개통 진행 중 건수가 많은 상위 매장 예시 (store_no → 진행중/개통완료/대응완료)
  - #51: 17 / 0 / 0, #46: 17 / 2 / 0, #1: 17 / 1 / 3 — **완료 비율이 극히 낮고 처리되지 않은 DB가 쌓여있음**.

## 5. 기획안에 대한 데이터 기반 시사점

1. **견적 확인 단계 생략 근거 충분**: `0201001` 잔여는 7건에 불과하고 `0201002`가 아예 사용되지 않습니다. 신규 DB가 곧바로 `개통 진행중`으로 넘어가도 운영상 영향이 없습니다.
2. **“고객 데이터” 통합 관리 필요**: 실제 데이터는 `반려/취소/대응완료/개통완료` 네 상태가 핵심입니다. 현재 UI는 상태별 페이지로 쪼개져 있지만 조회 API는 `step_code` 단일 값만 받기 때문에, 다중 상태 필터와 단일 화면 구성이 필수입니다.
3. **DB 구매 비용 대비 효율 낮음**: 3,180건 중 2,722건이 반려 상태로 남아 있어, 매장 입장에서는 아무 성과 없이 DB를 관리해야 하는 구조입니다. 월 구독형에 맞춰 `tb_store_purchase`를 폐지하거나 전환 로직을 리팩터링해야 합니다.
4. **자동 개통/완료 프로세스 재구현 필요**: 10월 14일 이후 개통완료가 없고 최근 2주간 진행이 사실상 “0”입니다. 배포 이전에 자동 전환 배치(또는 이벤트 기반 처리)를 만들어야 화면 개편 효과를 실제 운영 데이터에서 확인할 수 있습니다.
5. **고객 입력 정보 미활용**: open_info를 제출한 89건이 매장 미배정으로 방치되어 있어, 고객 데이터 메뉴에서 신청 상태 여부와 무관하게 검색/관리할 수 있는 DB 뷰가 필요합니다.

## 6. 권장 액션 아이템 (요약)

1. **API/배치**: `tb_apply_phone` 신규 INSERT 직후 `0201004` 로 자동 전환 + 구매 로직 분리. 동시에 기존 `state='0201001'` 잔여분 일괄 업데이트.
2. **조회 API 확장**: `stepCodes` 배열 파라미터 지원으로 하나의 화면에서 대응완료~취소까지 다중 상태를 불러오도록 MyBatis 쿼리 수정.
3. **DB 구매 정산 구조 개편**: `tb_store_purchase` 를 월 구독 메타데이터로 대체하거나 최소한 반려/취소 시 환불 처리 자동화를 구현.
4. **고객 정보 매핑**: `open_info_yn='Y'` 인 건을 매장 배정 여부와 상관없이 새 “고객 데이터” 화면에서 표준화된 컬럼으로 노출하고, 세부 정보 조회/메모 기능을 통합합니다.
5. **모니터링 대시보드**: 최근 7/30일 상태 별 건수, 개통완료 일자, store_no 별 미처리량 등을 자동으로 시각화하여 운영팀이 병목을 즉시 파악할 수 있게 합니다.

## 7. 기획 솔루션 개요 (Plan 2025-11-17 연계)

- **메뉴 재편**: “고객 관리 > 견적 신청”과 “고객 관리 > 고객 데이터” 두 페이지로 단순화하여 기존 `apply/phone/estimate/*` 다중 페이지를 통합합니다.
- **핵심 KPI**: 반려 비중 감소, 개통 완료 재개, 처리 시간 50% 단축을 목표로 하며 실행 일정은 11/08 데이터 클리닝 → 11/11 백엔드 → 11/15 프론트 → 11/18 베타 오픈 순으로 설정했습니다.
- **데이터 기반 스토리라인**
  - `진행중(0201002)` 단계가 미사용이므로 신규 DB는 자동으로 `개통 진행중`으로 전환.
  - 반려/취소 비중이 87%이므로 고객 데이터 페이지는 대응완료/반려/취소/개통완료/미배정 open_info를 한 화면에서 필터링하도록 설계.
  - 고객 입력 정보가 매장 미배정 상태로 쌓이고 있으므로, 상태와 무관하게 open_info를 확인하고 배정/메모/상세를 처리할 수 있는 공용 패널이 필요함.

## 8. UX & 화면 흐름 요약

| 구성 요소 | 설명 |
| --- | --- |
| 리스트 헤더 | 신청일 · 상태 · 고객/상품 · 진행 정보 · 메모 · 액션 6개 컬럼으로 통일. 상태는 파란/보라/회색 pill UI로 구분. |
| 고객 카드 예시 | `2025-11-03 10:14 · 개통 진행중 · 김도현 아이폰15 Pro(SKT)` 와 같이 실제 상태 조합으로 작성. |
| 상세 패널 | 우측 패널에서 open_info, 개통 증빙 이미지, 메모, 상태 변경 버튼을 한 번에 처리. 모바일에서는 카드형 전환. |

`plan_2025-11-17.html` 문서에서는 위 요소를 HTML wireframe으로 시각화했으며, 실제 데이터(예: store_no 51/46/1의 진행 현황)를 기반으로 사례를 구성했습니다.

## 9. 기술 변경 사항 (상세)

### 백엔드
- `ApplyPhoneService.modifyApplyPhoneOpening` 을 단일 서비스에서 분리하여 `ApplyPhoneAutoProcessor` (가칭)에 DB 구매, 캐시 차감, 알림톡 발송을 모듈화.
- Scheduler(`scheduler/apply`)가 30초 주기로 `step_code='0201001' AND store_no>0` 레코드를 자동 전환하고 실패 시 Slack 알림.
- `apply-phone-sqlmap.xml` 의 stepCode 조건을 `IN` 지원하도록 수정하고, `ReqApplyPhone` DTO에 `List<String> stepCodes` 추가.
- `tb_store_purchase` 는 `free_yn='Y'` 기본값, `cash_used` nullable로 변경해 월 구독 정책과 정합성을 맞추며, 기존 데이터는 history 테이블에 보관.
- open_info 미배정 건만 별도로 반환하는 `/apply/phone/customer-data` API 신설.

### 프런트엔드
- `apply/phone/estimate/applied/opening/completed.html` → `customer/lead.html`, `customer/data.html` 두 화면으로 리팩터링. 데이터테이블 필터는 상태 멀티셀렉트, 매장/기간 필터, open_info 토글 포함.
- 상세 패널 컴포넌트화 (메모, 파일 썸네일, 상태 변경 버튼) 후 모든 메뉴에서 동일하게 사용.
- 반응형 레이아웃: 768px 이하에서는 각 건을 카드형으로 표시하고 주요 액션(상세, 개통완료, 배정)을 드롭다운에 배치.

### 데이터/인프라
- `tb_apply_phone` 마이그레이션 스크립트: `UPDATE tb_apply_phone SET step_code='0201004' WHERE step_code='0201001' AND store_no>0`.
- `tb_store_purchase_history` 신설로 과거 구매 내역 보존, 정산팀 검증 후 기존 테이블은 월 구독 메타데이터 테이블로 전환.
- Grafana 대시보드 (최근 7/30일 상태별 건수, 개통 완료 일자, open_info 미배정 추이) 및 Slack 경보(자동 전환 실패, 개통 완료 3일 없음, 미배정 50건 이상).

## 10. 리스크 및 대응

| 리스크 | 영향 | 대응 |
| --- | --- | --- |
| 자동 개통 전환 실패 | DB 마스킹 유지로 고객 응대 지연 | Scheduler 재시도 + Fallback 버튼 + Slack 경보 |
| 다중 상태 조회 성능 하락 | UI 응답 속도 지연 | step/store/기간 인덱스 추가, 서버 페이징 유지 |
| 과거 DB 구매 정산 혼선 | 회계상 부채/환불 이슈 | history 보존 + 재무팀 검토 후 폐기 또는 환불 정책 수립 |

## 11. 실행 일정

1. **~11/08**: 데이터 클리닝 (step 업데이트, store_purchase history 분리, open_info 큐 구축)
2. **11/11**: 백엔드 개발 완료 (자동 전환, 다중 상태 API, open_info API)
3. **11/15**: 프런트/UX 적용 및 통합 QA
4. **11/18**: 베타 오픈 (매장 3곳 대상 운영, KPI 모니터링)

---

> 위 수치는 운영 DB 스냅샷 기준이며, 추가 쿼리가 필요하면 `scripts/db/agency_insights.sql` 형태로 정리해드릴 수 있습니다. 기획 상세는 `plan_2025-11-17.html`을 참고하세요.
